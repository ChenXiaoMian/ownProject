$(function(){function a(){store.remove("getTemp"),store.remove("getSearch"),store.remove("seatempTrading"),store.remove("StandardStr"),store.remove("market"),store.remove("medicine"),store.remove("base"),store.remove("standard"),initSearch(".sText-market",".sVal-market","关键字/市场名称"),initSearch(".sText-medicine",".sVal-medicine","关键字/中药材名称"),initSearch(".sText-base",".sVal-base","关键字/产地名称"),$("select[name='Scale'],select[name='MedicineType'],select[name='PriceTendency'],select[name='MarketStatus'],select[name='Standard']").find("option").removeAttr("selected"),$("select[name='Standard']").empty(),$("input[name='priceRange']").prop("disabled",!0).val(""),$(".getChooseTemp").text("默认模板").removeClass("c-3dbaff").addClass("c-c7c7c7")}function b(a){var b={};$.each(JSON.parse(store.get(f)).data,function(c,d){d.tid==a&&(b=d)}),$("select[name='Scale'],select[name='MedicineType']").find("option").removeAttr("selected"),$("select[name='Scale']").find('option[value="'+b.Scale+'"]').prop("selected",!0),$("select[name='MedicineType']").find('option[value="'+b.MedicineType+'"]').prop("selected",!0),$("input[name='MerchantName']").val(b.MerchantName),b.hasOwnProperty("StandardStr")&&""!=b.StandardStr&&($(".innerType").find("select[name='Standard']").each(function(){loadMedicineStandard($(this),b.StandardStr)}),store.set("StandardStr",b.StandardStr)),changeSearch(".sText-market",".sVal-market",b.Market),changeSearch(".sText-medicine",".sVal-medicine",b.Medicine),changeSearch(".sText-base",".sVal-base",b.BaseName),$(".weui-textarea").val(b.Addition),clearSearch(".sVal-market"),clearSearch(".sVal-medicine"),clearSearch(".sVal-base"),$(".innerType").empty(),$.each(b.innerType,function(a,b){var c=$(".innerType"),d=a+1,e='<form id="innerType'+d+'" name="innerType'+d+'" autocomplete="off"><div class="weui-cells weui-cells_form"><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label adLet">规 格 '+d+'</label></div><div class="weui-cell__bd"><select class="weui-select"name="Standard"></select></div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label ">交易数量<br/>(日平均)</label></div><div class="weui-cell__bd"><input class="weui-input"type="text"pattern="REG_NUMBER"notmatchtips="请输入正确的数字格式"placeholder=""name="TradeProduction"/></div><div class="weui-cell__dw c-c7c7c7">公斤</div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label ">交易价格<br/>(日平均)</label></div><div class="weui-cell__bd"><input class="weui-input"type="text"pattern="REG_NUMBER"notmatchtips="请输入正确的数字格式"required placeholder=""name="Price"emptyTips="请输入交易价格"/></div><div class="weui-cell__dw c-c7c7c7">元/公斤</div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label">价格趋势</label></div><div class="weui-cell__bd"><select class="weui-select"name="PriceTendency"><option value="">请选择</option><option value="持平">持平</option><option value="上升">上升</option><option value="下降">下降</option></select></div><div class="weui-cell__bd"><input class="weui-input"type="text"pattern="REG_NUMBER"notmatchtips="请输入正确的数字格式"disabled="disabled"placeholder="0"name="PriceRange"/></div><div class="weui-cell__dw flex-20 c-c7c7c7">%</div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label">市场表现</label></div><div class="weui-cell__bd"><select class="weui-select"name="MarketStatus"><option value="">请选择</option><option value="正常">正常</option><option value="活跃">活跃</option><option value="不活跃">不活跃</option></select></div></div></div></form>';c.append(e),weui.form.checkIfBlur("#innerType"+d,regexp)}),$(".innerType").find("select[name='Standard']").each(function(){loadMedicineStandard($(this),b.StandardStr)}),$.each(b.innerType,function(a,b){var a=a+1;$("#innerType"+a).find("select[name='Standard']").children('option[value="'+b.Standard+'"]').prop("selected",!0)})}function c(){var a=arguments,b=[];return $.each(a,function(a,c){var d=$("input[name='"+c+"']");if(""==$.trim(d.val()))return weui.topTips(d.attr("emptyTips")),!1;b.push(c)}),b.length===a.length}var d=(store.get("userName"),(new Date).Format("yyyy-MM-dd hh:mm:ss")),e=$(".js_dialog"),f="tempTrading";$(".getUserName").text(store.get("userName")),$(".getNow").text(d),getPosition(),setPosition($(".getLocation")),a(),weui.form.checkIfBlur("#form-trading",regexp),weui.form.checkIfBlur("#innerType1",regexp),$("#form-trading-submit").on("click",function(){weui.form.validate("#form-trading",function(b){if(!b){var c={},d=$("#form-trading").serializeArray(),e=$(".innerType form");if(c.UserName=store.get("loginName"),$.each(d,function(a,b){c[b.name]=b.value}),c.Addition=$("textarea[name='Addition']").val(),e.length>1){var f=[];if(e.each(function(a){weui.form.validate($(this),function(a){a&&f.push(a)},regexp)}),f.length>0)return!1;var g=[],h=[];e.each(function(a){var b=$(this).serializeArray(),c={};for(var d in b)c[b[d].name]=b[d].value;g.push(c)});var i=uniqeByKeys(g,["Standard"]);c.Address=Cookies.get("location")?Cookies.get("location"):"暂无位置",c.Time=(new Date).Format("yyyy-MM-dd hh:mm:ss");var j=weui.loading("上传中...");$.each(i,function(a,b){var d=cloneObj(c);$.extend(d,b),$.extend(d,{hid:"",cUserName:""}),$.ajax({url:$kmurl+"/saveTradeJSONP",type:"GET",contentType:"application/json; charset=utf-8",dataType:"jsonp",jsonp:"jsoncallback",data:{parms:JSON.stringify(d)},success:function(a){if(d.hid=(new Date).getTime(),d.cUserName=store.get("userName"),store.get("histTrading")&&""!=store.get("histTrading")){var b=JSON.parse(store.get("histTrading"));b.data.unshift(d),store.remove("histTrading"),store.set("histTrading",JSON.stringify(b))}else{var c={data:[]};c.data.unshift(d),store.set("histTrading",JSON.stringify(c))}d=null},error:function(a,b,c){h.push(c),d=null}})}),h.length>0?(j.hide(),weui.alert("上传失败")):(j.hide(),weui.toast("上传成功",2e3)),a()}else weui.form.validate("#innerType1",function(b){if(!b){var d=$("#innerType1").serializeArray();$.each(d,function(a,b){c[b.name]=b.value}),c.Address=Cookies.get("location")?Cookies.get("location"):"暂无位置",c.Time=(new Date).Format("yyyy-MM-dd hh:mm:ss");weui.loading("上传中...");uploader(c,"/saveTradeJSONP",function(){if(c.hid=(new Date).getTime(),c.cUserName=store.get("userName"),store.get("histTrading")&&""!=store.get("histTrading")){var b=JSON.parse(store.get("histTrading"));b.data.unshift(c),store.remove("histTrading"),store.set("histTrading",JSON.stringify(b))}else{var d={data:[]};d.data.unshift(c),store.set("histTrading",JSON.stringify(d))}a(),document.formTrading.reset(),document.innerType1.reset()})}},regexp)}},regexp)}),$("#open-temp-dialog").on("click",function(){var a=$(".getChooseTemp").data("tid");if(c("Market","Medicine","BaseName")){var b=$(".innerType").find("form[name^='innerType']");if(a&&""!=a){var d=JSON.parse(store.get(f)),g=0,h={};$.each(d.data,function(b,c){c.tid==a&&(g=b,h=c)});var i,j={Market:$("input[name='Market']").val(),MerchantName:$("input[name='MerchantName']").val(),Scale:$("select[name='Scale']").val(),Medicine:$("input[name='Medicine']").val(),BaseName:$("input[name='BaseName']").val(),MedicineType:$("select[name='MedicineType']").val(),StandardStr:store.get("StandardStr")?store.get("StandardStr"):d.data[g].StandardStr,Addition:$.trim($("textarea[name='Addition']").val()),innerType:[]},k=[];b.each(function(a){var b=$(this).serializeArray(),c={};for(var d in b)c[b[d].name]=b[d].value;k.push(c)}),i=uniqeByKeys(k,["Standard"]),j.innerType=i,$.extend(h,j),d.data.splice(g,1,h);var l=weui.loading("保存中...");store.remove(f),store.set(f,JSON.stringify(d)),l.hide(),weui.toast("模板保存成功",500)}else e.fadeIn(200)}}),$(".js_dialog").on("click",".weui-dialog__btn_default",function(){$(this).parents(".js_dialog").fadeOut(200)}),$("#save-for-temp").on("click",function(){if(c("tempName")){$(this).parents(".js_dialog").fadeOut(200);var a,b={IsDefault:"0",tempTitle:$("input[name='tempName']").val(),Market:$("input[name='Market']").val(),MerchantName:$("input[name='MerchantName']").val(),Scale:$("select[name='Scale']").val(),Medicine:$("input[name='Medicine']").val(),BaseName:$("input[name='BaseName']").val(),MedicineType:$("select[name='MedicineType']").val(),StandardStr:store.get("StandardStr")?store.get("StandardStr"):"",Addition:$.trim($("textarea[name='Addition']").val()),Address:Cookies.get("location")?Cookies.get("location"):"暂无位置",Time:(new Date).Format("yyyy-MM-dd hh:mm:ss"),tid:(new Date).getTime(),innerType:[]},d=$(".innerType").find("form[name^='innerType']"),e=[];d.each(function(a){var b=$(this).serializeArray(),c={};for(var d in b)c[b[d].name]=b[d].value;e.push(c)}),a=uniqeByKeys(e,["Standard"]),b.innerType=a;var g=store.get(f)?store.get(f):"";if(g&&""!=g){if(JSON.parse(g).data.length>=$tempNum)return weui.alert("创建最多"+$tempNum+"个模板"),!1}var h=weui.loading("保存中...");if(""==g||isEmpty(JSON.parse(g).data)){var i={data:[]};i.data.unshift(b),store.set(f,JSON.stringify(i))}else{var j=JSON.parse(g);j.data.unshift(b),store.remove(f),store.set(f,JSON.stringify(j))}h.hide(),weui.toast("模板保存成功",500)}}),$(window).on("hashchange",function(a){a.preventDefault();var c=/#tempChoose$/,d=/#addTrading$/,e=/#itemSearch$/;if(c.test(a.oldURL)&&d.test(a.newURL)){var f=store.get("seatempTrading")?store.get("seatempTrading"):"";""!=f&&(isEmpty(JSON.parse(f))||($(".getChooseTemp").text(JSON.parse(f).name).data("tid",JSON.parse(f).id).removeClass("c-c7c7c7").addClass("c-3dbaff"),b(JSON.parse(f).id),store.remove("seatempTrading")))}else if(e.test(a.oldURL)&&d.test(a.newURL)){var g=store.get("base")?store.get("base"):"";""!=g&&(isEmpty(JSON.parse(g))||(changeSearch(".sText-base",".sVal-base",JSON.parse(g).name),clearSearch(".sVal-base"),store.remove("base")));var h=store.get("market")?store.get("market"):"";""!=h&&(isEmpty(JSON.parse(h))||(changeSearch(".sText-market",".sVal-market",JSON.parse(h).name),clearSearch(".sVal-market"),store.remove("market")));var i=store.get("medicine")?store.get("medicine"):"";$("select[name='Standard']");""!=i&&(isEmpty(JSON.parse(i))||(changeSearch(".sText-medicine",".sVal-medicine",JSON.parse(i).name),store.set("StandardStr",JSON.parse(i).standard),$(".innerType").find("select[name='Standard']").each(function(){loadMedicineStandard($(this),JSON.parse(i).standard)}),clearSearch(".sVal-medicine"),store.remove("medicine")))}}),$(".innerType").on("change",'select[name="PriceTendency"]',function(){var a=$(this).val(),b=$(this).parents(".weui-cell").find("input[name='PriceRange']");""==a||"持平"==a?b.prop("disabled",!0).val(""):b.prop("disabled",!1)}),$(".innerType").on("input propertychange",'input[name="Price"]',function(){clearInput($(this))}),$("#btnAddStandard").on("click",function(){var a=$(".innerType"),b=a.find("form").length+1;if(b<11){var c='<form id="innerType'+b+'" name="innerType'+b+'" autocomplete="off"><div class="weui-cells weui-cells_form"><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label adLet">规 格 '+b+'</label></div><div class="weui-cell__bd"><select class="weui-select"name="Standard"></select></div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label ">交易数量<br/>(日平均)</label></div><div class="weui-cell__bd"><input class="weui-input"type="text"placeholder=""name="TradeProduction" pattern="REG_NUMBER" notmatchtips="请输入正确的数字格式"/></div><div class="weui-cell__dw c-c7c7c7">公斤</div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label ">交易价格<br/>(日平均)</label></div><div class="weui-cell__bd"><input class="weui-input" type="text" placeholder=""name="Price"emptyTips="请输入交易价格" pattern="REG_NUMBER" notmatchtips="请输入正确的数字格式"/></div><div class="weui-cell__dw c-c7c7c7">元/公斤</div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label">价格趋势</label></div><div class="weui-cell__bd"><select class="weui-select"name="PriceTendency"><option value="">请选择</option><option value="持平">持平</option><option value="上升">上升</option><option value="下降">下降</option></select></div><div class="weui-cell__bd"><input class="weui-input"type="text"disabled="disabled"placeholder="0"name="PriceRange" pattern="REG_NUMBER" notmatchtips="请输入正确的数字格式"/></div><div class="weui-cell__dw flex-20 c-c7c7c7">%</div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label">市场表现</label></div><div class="weui-cell__bd"><select class="weui-select"name="MarketStatus"><option value="">请选择</option><option value="正常">正常</option><option value="活跃">活跃</option><option value="不活跃">不活跃</option></select></div></div></div></form>';a.append(c),weui.form.checkIfBlur("#innerType"+b,regexp);var d=$("#innerType"+b).find("select[name='Standard']"),e=store.get("StandardStr");e&&""!=e&&loadMedicineStandard(d,e)}else weui.alert("最多可添加10个规格")})});