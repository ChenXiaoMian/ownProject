$(function(){function a(){store.remove("market"),store.remove("medicine"),store.remove("base"),store.remove("standard"),store.remove("StandardStr"),initSearch(".sText-market",".sVal-market","关键字/市场名称"),initSearch(".sText-medicine",".sVal-medicine","关键字/中药材名称"),initSearch(".sText-base",".sVal-base","关键字/产地名称")}function b(){a(),e&&""!=e?(f.hide(),g.show(),$(".firstTemp").prepend(h),d(j,e)):(g.hide(),f.show(),$("#form-trading-temp").append(i))}function c(a,b){var c=JSON.parse(store.get(a)),d={};return $.each(c.data,function(a,c){c.tid==b&&(d=c)}),d.StandardStr}function d(a,b){var c=JSON.parse(store.get(a)),d={};$.each(c.data,function(a,c){c.tid==b&&(d=c)}),$("select[name='Scale'],select[name='MedicineType']").find("option").removeAttr("selected"),$("select[name='Scale']").find('option[value="'+d.Scale+'"]').prop("selected",!0),$("select[name='MedicineType']").find('option[value="'+d.MedicineType+'"]').prop("selected",!0),$("input[name='MerchantName']").val(d.MerchantName),changeSearch(".sText-market",".sVal-market",d.Market),changeSearch(".sText-medicine",".sVal-medicine",d.Medicine),changeSearch(".sText-base",".sVal-base",d.BaseName),$("input[name='tempTitle']").val(d.tempTitle),$("textarea[name='Addition']").val(d.Addition),1==d.IsDefault&&$("input[name='IsDefault']").prop("checked","checked").val("1"),$(".innerType").empty(),$.each(d.innerType,function(a,b){var c=$(".innerType"),d=a+1,e='<form id="innerType'+d+'" name="innerType'+d+'" autocomplete="off"><div class="weui-cells weui-cells_form"><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label adLet">规 格 '+d+'</label></div><div class="weui-cell__bd"><select class="weui-select"name="Standard"></select></div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label ">交易数量<br/>(日平均)</label></div><div class="weui-cell__bd"><input class="weui-input"type="text"pattern="REG_NUMBER"notmatchtips="请输入正确的数字格式"placeholder=""name="TradeProduction" disabled="disabled"/></div><div class="weui-cell__dw c-c7c7c7">公斤</div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label ">交易价格<br/>(日平均)</label></div><div class="weui-cell__bd"><input class="weui-input"type="text"pattern="REG_NUMBER"notmatchtips="请输入正确的数字格式"required placeholder=""name="Price"emptyTips="请输入交易价格" disabled="disabled"/></div><div class="weui-cell__dw c-c7c7c7">元/公斤</div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label">价格趋势</label></div><div class="weui-cell__bd"><select class="weui-select"name="PriceTendency" disabled="disabled"><option value="">请选择</option><option value="持平">持平</option><option value="上升">上升</option><option value="下降">下降</option></select></div><div class="weui-cell__bd"><input class="weui-input"type="text"pattern="REG_NUMBER"notmatchtips="请输入正确的数字格式"disabled="disabled"placeholder="0"name="PriceRange"/></div><div class="weui-cell__dw flex-20 c-c7c7c7">%</div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label">市场表现</label></div><div class="weui-cell__bd"><select class="weui-select"name="MarketStatus" disabled="disabled"><option value="">请选择</option><option value="正常">正常</option><option value="活跃">活跃</option><option value="不活跃">不活跃</option></select></div></div></div></form>';c.append(e),weui.form.checkIfBlur("#innerType"+d,regexp)}),$(".innerType").find("select[name='Standard']").each(function(){loadMedicineStandard($(this),d.StandardStr)}),$.each(d.innerType,function(a,b){var a=a+1;$("#innerType"+a).find("select[name='Standard']").children('option[value="'+b.Standard+'"]').prop("selected",!0)})}var e=((new Date).Format("yyyy-MM-dd hh:mm:ss"),store.get("editTemp")?store.get("editTemp"):""),f=$(".addPanel"),g=$(".editPanel"),h='<div class="weui-cell tempName"><div class="weui-cell__hd km-line"><label class="weui-label">模板名称</label></div><div class="weui-cell__bd"><input class="weui-input" type="text" required name="tempTitle" placeholder="请输入模板名称" /></div></div>',i='<div class="js_dialog" style="display: none;"><div class="weui-mask"></div><div class="weui-dialog"><div class="weui-dialog__hd pt-15"><strong class="weui-dialog__title c-000000">提示</strong></div><div class="weui-dialog__bd"><input class="weui-input"required type="text" name="tempTitle" placeholder="填写模板名称"/></div><div class="weui-dialog__ft"><a href="javascript:;"class="weui-dialog__btn weui-dialog__btn_default">取消</a><a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary c-3dbaff" id="form-temp-submit">保存</a></div></div></div>',j=store.get("chooseTemp")?store.get("chooseTemp"):"";b(),$(window).on("hashchange",function(a){a.preventDefault();var b=/#tempTrading$/;if(/#itemSearch$/.test(a.oldURL)&&b.test(a.newURL)){var c=store.get("base")?store.get("base"):"";""!=c&&(isEmpty(JSON.parse(c))||(changeSearch(".sText-base",".sVal-base",JSON.parse(c).name),clearSearch(".sVal-base"),store.remove("base")));var d=store.get("market")?store.get("market"):"";""!=d&&(isEmpty(JSON.parse(d))||(changeSearch(".sText-market",".sVal-market",JSON.parse(d).name),clearSearch(".sVal-market"),store.remove("market")));var e=store.get("medicine")?store.get("medicine"):"";$("select[name='Standard']"),""!=e&&(isEmpty(JSON.parse(e))||(changeSearch(".sText-medicine",".sVal-medicine",JSON.parse(e).name),store.set("StandardStr",JSON.parse(e).standard),$(".innerType").find("select[name='Standard']").each(function(){loadMedicineStandard($(this),JSON.parse(e).standard)}),clearSearch(".sVal-medicine"),store.remove("medicine")))}}),weui.form.checkIfBlur("#form-trading-temp",regexp),$(".js_dialog").on("click",".weui-dialog__btn_default",function(){$(this).parents(".js_dialog").fadeOut(200)}),$(".btnShowDialog").on("click",function(){$("#form-trading-temp").find(".js_dialog").fadeIn(200),$("#form-trading-temp").find("input[name='tempTitle']").focus()}),$("input[name='IsDefault']").on("change",function(){var a=$(this).is(":checked")?1:0;$(this).val(a)}),$(".innerType").on("change",'select[name="PriceTendency"]',function(){var a=$(this).val(),b=$(this).parents(".weui-cell").find("input[name='PriceRange']");""==a||"持平"==a?b.prop("disabled",!0).val(""):b.prop("disabled",!1)}),$(".innerType").on("input propertychange",'input[name="Price"]',function(){clearInput($(this))}),$("#btnAddStandard").on("click",function(){var a=$(".innerType"),b=a.find("form").length+1;if(b<11){var d='<form id="innerType'+b+'" name="innerType'+b+'" autocomplete="off"><div class="weui-cells weui-cells_form"><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label adLet">规 格 '+b+'</label></div><div class="weui-cell__bd"><select class="weui-select"name="Standard"></select></div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label ">交易数量<br/>(日平均)</label></div><div class="weui-cell__bd"><input class="weui-input"type="text"pattern="REG_NUMBER"notmatchtips="请输入正确的数字格式"placeholder=""name="TradeProduction" disabled="disabled"/></div><div class="weui-cell__dw c-c7c7c7">公斤</div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label ">交易价格<br/>(日平均)</label></div><div class="weui-cell__bd"><input class="weui-input"type="text"pattern="REG_NUMBER"notmatchtips="请输入正确的数字格式"required placeholder=""name="Price"emptyTips="请输入交易价格" disabled="disabled"/></div><div class="weui-cell__dw c-c7c7c7">元/公斤</div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label">价格趋势</label></div><div class="weui-cell__bd"><select class="weui-select"name="PriceTendency" disabled="disabled"><option value="">请选择</option><option value="持平">持平</option><option value="上升">上升</option><option value="下降">下降</option></select></div><div class="weui-cell__bd"><input class="weui-input"type="text"pattern="REG_NUMBER"notmatchtips="请输入正确的数字格式"disabled="disabled"placeholder="0"name="PriceRange"/></div><div class="weui-cell__dw flex-20 c-c7c7c7">%</div></div><div class="weui-cell"><div class="weui-cell__hd km-line"><label class="weui-label">市场表现</label></div><div class="weui-cell__bd"><select class="weui-select"name="MarketStatus" disabled="disabled"><option value="">请选择</option><option value="正常">正常</option><option value="活跃">活跃</option><option value="不活跃">不活跃</option></select></div></div></div></form>';a.append(d),weui.form.checkIfBlur("#innerType"+b,regexp);var f=$("#innerType"+b).find("select[name='Standard']"),g=store.get("StandardStr")||c(j,e);g&&""!=g&&loadMedicineStandard(f,g)}else weui.alert("最多可添加10个规格")}),$(".tempTrading").on("click","#form-temp-edit",function(){weui.form.validate("#form-trading-temp",function(a){if(!a){var b={},c=$("#form-trading-temp").serializeArray(),d=JSON.parse(store.get(j)),f=0;b.IsDefault="0",$.each(c,function(a,c){b[c.name]=c.value}),b.Time=(new Date).Format("yyyy-MM-dd hh:mm:ss"),$.each(d.data,function(a,c){1==b.IsDefault&&(c.IsDefault="0"),c.tid==e&&(f=a)}),b.tid=e,b.StandardStr=store.get("StandardStr")?store.get("StandardStr"):d.data[f].StandardStr,b.innerType=[];var g,h=$(".innerType").find("form[name^='innerType']"),i=[];h.each(function(a){var b=$(this).serializeArray(),c={};for(var d in b)c[b[d].name]=b[d].value;i.push(c)}),g=uniqeByKeys(i,["Standard"]),b.innerType=g,d.data.splice(f,1,b);var k=weui.loading("保存中...");store.remove("tempTrading"),store.set("tempTrading",JSON.stringify(d)),k.hide(),weui.toast("模板保存成功",500),setTimeout(function(){window.pageManager.back()},800)}},regexp)}),$("#form-trading-temp").on("click","#form-temp-submit",function(){weui.form.validate("#form-trading-temp",function(b){if(!b){var c={},d=$("#form-trading-temp").serializeArray();c.IsDefault="0",$.each(d,function(a,b){c[b.name]=b.value}),c.Time=(new Date).Format("yyyy-MM-dd hh:mm:ss"),c.tid=(new Date).getTime(),c.StandardStr=store.get("StandardStr")?store.get("StandardStr"):"",c.innerType=[];var e,f=$(".innerType").find("form[name^='innerType']"),g=[];f.each(function(a){var b=$(this).serializeArray(),c={};for(var d in b)c[b[d].name]=b[d].value;g.push(c)}),e=uniqeByKeys(g,["Standard"]),c.innerType=e;var h=weui.loading("保存中..."),i=store.get("tempTrading")?store.get("tempTrading"):"";if(""==i||isEmpty(JSON.parse(i).data)){var j={data:[]};j.data.unshift(c),store.set("tempTrading",JSON.stringify(j))}else{var k=JSON.parse(i);1==c.IsDefault&&$.each(tempStock.data,function(a,b){b.IsDefault="0"}),k.data.unshift(c),store.remove("tempTrading"),store.set("tempTrading",JSON.stringify(k))}a(),$(".js_dialog").fadeOut(200),h.hide(),weui.toast("模板保存成功",500),setTimeout(function(){window.pageManager.back()},800)}},regexp)})});