$(function(){function a(){store.remove("manufacturer"),store.remove("medicine"),store.remove("base"),initSearch(".sText-manufacturer",".sVal-manufacturer","关键字/生产商名称"),initSearch(".sText-medicine",".sVal-medicine","关键字/中药材名称"),initSearch(".sText-base",".sVal-base","关键字/产地名称")}function b(){a(),e&&""!=e?(f.hide(),g.show(),$(".firstTemp").prepend(h),d(k,e)):(g.hide(),f.show(),$("#form-pro-temp").append(i))}function c(a){var b={};b.userName=store.get("loginName"),b.password=store.get("password"),b.medicine=a,$.ajax({url:$kmurl+"/likeMedicine",type:"GET",contentType:"application/json;charset=utf-8",dataType:"jsonp",jsonp:"jsoncallback",data:{parms:JSON.stringify(b)},success:function(a){if("success"==a.result&&!isEmpty(JSON.parse(a.message))){var b=JSON.parse(a.message);j=b[0].standard}},error:function(a,b,c){console.log("输入参数错误，请核对！")}})}function d(a,b){var d=JSON.parse(store.get(a)),e={},f=$("select[name='MedicineStandard']");$.each(d.data,function(a,c){c.tid==b&&(e=c)}),console.log(d.data),c(e.MedicineName),$("select[name='Product'],select[name='MedicineStandard']").find("option").removeAttr("selected"),$("select[name='Product']").find('option[value="'+e.Product+'"]').prop("selected",!0),$("input[name='ProductName']").val(e.ProductName),$("input[name='Standard']").val(e.Standard),changeSearch(".sText-manufacturer",".sVal-manufacturer",e.ManufacturerName),changeSearch(".sText-medicine",".sVal-medicine",e.MedicineName),changeSearch(".sText-base",".sVal-base",e.BaseName),$("input[name='tempTitle']").val(e.tempTitle),$("input[name='Ratio']").val(e.Ratio),setTimeout(function(){var a=[],b="";a=j.split(","),a.length>0?(f.empty(),$.each(a,function(a,c){b+='<option value="'+c+'">'+c+"</option>"}),f.html(b).find('option[value="'+e.MedicineStandard+'"]').attr("selected",!0)):f.empty()},1e3),$("input[name='Supplier']").val(e.Supplier),$("input[name='QualityRequire']").val(e.QualityRequire),$("textarea[name='Addition']").val(e.Addition),1==e.IsDefault&&$("input[name='IsDefault']").prop("checked","checked").val("1")}var e=((new Date).Format("yyyy-MM-dd hh:mm:ss"),store.get("editTemp")?store.get("editTemp"):""),f=$(".addPanel"),g=$(".editPanel"),h='<div class="weui-cell tempName"><div class="weui-cell__hd km-line"><label class="weui-label">模板名称</label></div><div class="weui-cell__bd"><input class="weui-input" type="text" required name="tempTitle" placeholder="请输入模板名称" /></div></div>',i='<div class="js_dialog" style="display: none;"><div class="weui-mask"></div><div class="weui-dialog"><div class="weui-dialog__hd pt-15"><strong class="weui-dialog__title c-000000">提示</strong></div><div class="weui-dialog__bd"><input class="weui-input"required type="text" name="tempTitle" placeholder="填写模板名称"/></div><div class="weui-dialog__ft"><a href="javascript:;"class="weui-dialog__btn weui-dialog__btn_default">取消</a><a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary c-3dbaff" id="form-temp-submit">保存</a></div></div></div>',j="",k=store.get("chooseTemp")?store.get("chooseTemp"):"";b(),$(window).on("hashchange",function(a){a.preventDefault();var b=/#tempPro$/;if(/#itemSearch$/.test(a.oldURL)&&b.test(a.newURL)){var c=store.get("base")?store.get("base"):"",c=store.get("base")?store.get("base"):"";""!=c&&(isEmpty(JSON.parse(c))||(changeSearch(".sText-base",".sVal-base",JSON.parse(c).name),clearSearch(".sVal-base"),store.remove("base")));var d=store.get("manufacturer")?store.get("manufacturer"):"";""!=d&&(isEmpty(JSON.parse(d))||(changeSearch(".sText-manufacturer",".sVal-manufacturer",JSON.parse(d).name),clearSearch(".sVal-manufacturer"),store.remove("manufacturer")));var e=store.get("medicine")?store.get("medicine"):"",f=$("select[name='MedicineStandard']");if(""!=e&&!isEmpty(JSON.parse(e))){changeSearch(".sText-medicine",".sVal-medicine",JSON.parse(e).name);var g=JSON.parse(e).standard,h=[],i="";h=g.split(","),h.length>0?(f.empty(),$.each(h,function(a,b){i+='<option value="'+b+'">'+b+"</option>"}),f.html(i)):f.empty(),clearSearch(".sVal-medicine"),store.remove("medicine")}}}),weui.form.checkIfBlur("#form-pro-temp",regexp),$(".js_dialog").on("click",".weui-dialog__btn_default",function(){$(this).parents(".js_dialog").fadeOut(200)}),$(".btnShowDialog").on("click",function(){$(this).parents("form").find(".js_dialog").fadeIn(200)}),$("input[name='IsDefault']").on("change",function(){var a=$(this).is(":checked")?1:0;$(this).val(a)}),$("#form-pro-temp").on("click","#form-temp-edit",function(){weui.form.validate("#form-pro-temp",function(a){if(console.log(a),!a){var b={},c=$("#form-pro-temp").serializeArray(),d=JSON.parse(store.get(k)),f=0;b.IsDefault="0",$.each(c,function(a,c){b[c.name]=c.value}),b.Time=(new Date).Format("yyyy-MM-dd hh:mm:ss"),$.each(d.data,function(a,c){1==b.IsDefault&&(c.IsDefault="0"),c.tid==e&&(f=a)}),b.tid=e,d.data.splice(f,1,b);var g=weui.loading("保存中...");store.remove("tempPro"),store.set("tempPro",JSON.stringify(d)),g.hide(),weui.toast("模板保存成功",500),setTimeout(function(){window.pageManager.back()},800)}},regexp)}),$("#form-pro-temp").on("click","#form-temp-submit",function(){weui.form.validate("#form-pro-temp",function(b){if(console.log(b),!b){var c={},d=$("#form-pro-temp").serializeArray();c.IsDefault="0",$.each(d,function(a,b){c[b.name]=b.value}),c.Time=(new Date).Format("yyyy-MM-dd hh:mm:ss"),c.tid=(new Date).getTime(),console.log(c);var e=weui.loading("保存中..."),f=store.get("tempPro")?store.get("tempPro"):"";if(""==f||isEmpty(JSON.parse(f).data)){var g={data:[]};g.data.unshift(c),store.set("tempPro",JSON.stringify(g))}else{var h=JSON.parse(f);1==c.IsDefault&&$.each(tempStock.data,function(a,b){b.IsDefault="0"}),h.data.unshift(c),store.remove("tempPro"),store.set("tempPro",JSON.stringify(h))}a(),$(".js_dialog").fadeOut(200),document.formProTemp.reset(),e.hide(),weui.toast("模板保存成功",500),setTimeout(function(){window.pageManager.back()},800)}},regexp)}),$(".btnShowDialog").on("click",function(){$("#form-pro-temp").find("input[name='tempTitle']").focus()})});