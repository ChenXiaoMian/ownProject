$(function(){function a(){store.remove("market"),store.remove("medicine"),initSearch(".stockText-market",".stockVal-market","关键字/市场名称"),initSearch(".stockText-medicine",".stockVal-medicine","关键字/中药材名称")}function b(){a(),d&&""!=d?(e.hide(),f.show(),$(".firstTemp").prepend(g),c(i,d)):(f.hide(),e.show(),$("#form-stock-temp").append(h))}function c(a,b){var c=JSON.parse(store.get(a)),d={};$.each(c.data,function(a,c){c.tid==b&&(d=c)}),console.log(c.data),changeSearch(".stockText-market",".stockVal-market",d.Market),changeSearch(".stockText-medicine",".stockVal-medicine",d.Medicine),$("#form-stock-temp").find("input[name='tempTitle']").val(d.tempTitle),$("#form-stock-temp").find("textarea[name='Addition']").val(d.Addition),1==d.IsDefault&&$("#form-stock-temp").find("input[name='IsDefault']").prop("checked","checked").val("1")}var d=((new Date).Format("yyyy-MM-dd hh:mm:ss"),store.get("editTemp")?store.get("editTemp"):""),e=$(".addPanel"),f=$(".editPanel"),g='<div class="weui-cell tempName"><div class="weui-cell__hd km-line"><label class="weui-label">模板名称</label></div><div class="weui-cell__bd"><input class="weui-input" type="text" required name="tempTitle" placeholder="请输入模板名称" /></div></div>',h='<div class="js_dialog" style="display: none;"><div class="weui-mask"></div><div class="weui-dialog"><div class="weui-dialog__hd pt-15"><strong class="weui-dialog__title c-000000">提示</strong></div><div class="weui-dialog__bd"><input class="weui-input"required type="text" name="tempTitle" placeholder="填写模板名称"/></div><div class="weui-dialog__ft"><a href="javascript:;"class="weui-dialog__btn weui-dialog__btn_default">取消</a><a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary c-3dbaff" id="form-stock-temp-submit">保存</a></div></div></div>',i=store.get("chooseTemp")?store.get("chooseTemp"):"";b(),$(window).on("hashchange",function(a){a.preventDefault();var b=/#tempStock$/;if(/#itemSearch$/.test(a.oldURL)&&b.test(a.newURL)){var c=store.get("market")?store.get("market"):"";""!=c&&(isEmpty(JSON.parse(c))||(changeSearch(".stockText-market",".stockVal-market",JSON.parse(c).name),clearSearch(".stockVal-market"),store.remove("market")));var d=store.get("medicine")?store.get("medicine"):"";""!=d&&(isEmpty(JSON.parse(d))||(changeSearch(".stockText-medicine",".stockVal-medicine",JSON.parse(d).name),clearSearch(".stockVal-medicine"),store.remove("medicine")))}});var j={regexp:{IDNUM:/(?:^\d{15}$)|(?:^\d{18}$)|^\d{17}[\dXx]$/,VCODE:/^.{4}$/}};weui.form.checkIfBlur("#form-stock-temp",j),$(".js_dialog").on("click",".weui-dialog__btn_default",function(){$(this).parents(".js_dialog").fadeOut(200)}),$(".btnShowDialog").on("click",function(){$(this).parents("form").find(".js_dialog").fadeIn(200)}),$("input[name='IsDefault']").on("change",function(){var a=$(this).is(":checked")?1:0;$(this).val(a)}),$("#form-stock-temp").on("click","#form-stock-temp-edit",function(){weui.form.validate("#form-stock-temp",function(a){if(console.log(a),!a){var b={},c=$("#form-stock-temp").serializeArray(),e=JSON.parse(store.get(i)),f=0;b.IsDefault="0",$.each(c,function(a,c){b[c.name]=c.value}),b.Time=(new Date).Format("yyyy-MM-dd hh:mm:ss"),$.each(e.data,function(a,c){1==b.IsDefault&&(c.IsDefault="0"),c.tid==d&&(f=a)}),b.tid=d,e.data.splice(f,1,b);var g=weui.loading("保存中...");store.remove("tempStock"),store.set("tempStock",JSON.stringify(e)),g.hide(),weui.toast("模板保存成功",500),setTimeout(function(){window.pageManager.back()},800)}},j)}),$("#form-stock-temp").on("click","#form-stock-temp-submit",function(){weui.form.validate("#form-stock-temp",function(a){if(console.log(a),!a){var b={},c=$("#form-stock-temp").serializeArray();b.IsDefault="0",$.each(c,function(a,c){b[c.name]=c.value}),b.Time=(new Date).Format("yyyy-MM-dd hh:mm:ss"),b.tid=(new Date).getTime(),console.log(b);var d=weui.loading("保存中...");if(store.get("tempStock")&&""!=store.get("tempStock")){var e=JSON.parse(store.get("tempStock"));1==b.IsDefault&&$.each(e.data,function(a,b){b.IsDefault="0"}),e.data.unshift(b),store.remove("tempStock"),store.set("tempStock",JSON.stringify(e))}else{var f={data:[]};f.data.unshift(b),store.set("tempStock",JSON.stringify(f))}store.remove("market"),store.remove("medicine"),initSearch(".stockText-market",".stockVal-market","关键字/市场名称"),initSearch(".stockText-medicine",".stockVal-medicine","关键字/中药材名称"),$(".js_dialog").fadeOut(200),document.formStockTemp.reset(),d.hide(),weui.toast("模板保存成功",500),setTimeout(function(){window.pageManager.back()},800)}},j)}),$(".btnShowDialog").on("click",function(){$("#form-stock-temp").find("input[name='tempTitle']").focus()})});