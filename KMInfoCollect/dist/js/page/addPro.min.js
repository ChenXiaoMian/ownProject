$(function(){function a(){store.remove("getTemp"),store.remove("getSearch"),store.remove("seatempPro"),store.remove("manufacturer"),store.remove("medicine"),store.remove("base"),initSearch(".sText-manufacturer",".sVal-manufacturer","关键字/生产商名称"),initSearch(".sText-medicine",".sVal-medicine","关键字/中药材名称"),initSearch(".sText-base",".sVal-base","关键字/产地名称"),$("select[name='Product'],select[name='MedicineStandard']").find("option").removeAttr("selected"),$("select[name='MedicineStandard']").empty(),$(".getChooseTemp").text("默认模板").removeClass("c-3dbaff").addClass("c-c7c7c7")}function b(a){var b={},c=$("select[name='MedicineStandard']");$.each(JSON.parse(store.get(e)).data,function(c,d){d.tid==a&&(b=d)}),$("select[name='Product'],select[name='MedicineStandard']").find("option").removeAttr("selected"),$("select[name='Product']").find('option[value="'+b.Product+'"]').prop("selected",!0),$("input[name='ProductName']").val(b.ProductName),$("input[name='Standard']").val(b.Standard),changeSearch(".sText-manufacturer",".sVal-manufacturer",b.ManufacturerName),changeSearch(".sText-medicine",".sVal-medicine",b.MedicineName),changeSearch(".sText-base",".sVal-base",b.BaseName),$("input[name='Ratio']").val(b.Ratio),b.hasOwnProperty("StandardStr")&&""!=b.StandardStr&&(loadMedicineStandard(c,b.StandardStr),c.find('option[value="'+b.MedicineStandard+'"]').attr("selected",!0)),$("input[name='Supplier']").val(b.Supplier),$("input[name='QualityRequire']").val(b.QualityRequire),$(".weui-textarea").val(b.Addition),clearSearch(".sVal-manufacturer"),clearSearch(".sVal-medicine"),clearSearch(".sVal-base")}var c=(store.get("userName"),(new Date).Format("yyyy-MM-dd hh:mm:ss")),d=$(".js_dialog"),e="tempPro";$(".getUserName").text(store.get("userName")),$(".getNow").text(c),getPosition(),setPosition($(".getLocation")),a(),weui.form.checkIfBlur("#form-pro",regexp);var f=function(a){switch(a){case"成药":return"/saveManufactureMedicineJSONP";case"食品":return"/saveManufactureFoodJSONP";case"保健品":return"/saveManufactureHealthProductsJSONP"}};$("#form-pro-submit").on("click",function(){weui.form.validate("#form-pro",function(b){if(console.log(b),!b){var c={},d=$("#form-pro").serializeArray();c.UserName=store.get("loginName"),$.each(d,function(a,b){c[b.name]=b.value}),c.Address=Cookies.get("location")?Cookies.get("location"):"暂无位置",c.Time=(new Date).Format("yyyy-MM-dd hh:mm:ss");weui.loading("上传中...");uploader(c,f(c.Product),function(){if(c.hid=(new Date).getTime(),c.cUserName=store.get("userName"),store.get("histPro")&&""!=store.get("histPro")){var b=JSON.parse(store.get("histPro"));b.data.unshift(c),store.remove("histPro"),store.set("histPro",JSON.stringify(b))}else{var d={data:[]};d.data.unshift(c),store.set("histPro",JSON.stringify(d))}console.log(c),a(),document.formPro.reset()})}},regexp)}),$("#open-temp-dialog").on("click",function(){var a=$(".getChooseTemp").data("tid");if(validateTemp("ManufacturerName","MedicineName","BaseName"))if(a&&""!=a){var b={Product:$("select[name='Product']").val(),ProductName:$("input[name='ProductName']").val(),Standard:$("input[name='Standard']").val(),ManufacturerName:$("input[name='ManufacturerName']").val(),MedicineName:$("input[name='MedicineName']").val(),BaseName:$("input[name='BaseName']").val(),Ratio:$("input[name='Ratio']").val(),MedicineStandard:$("select[name='MedicineStandard']").val(),StandardStr:store.get("StandardStr")?store.get("StandardStr"):"",Supplier:$("input[name='Supplier']").val(),QualityRequire:$("input[name='QualityRequire']").val(),Addition:$.trim($("textarea[name='Addition']").val())},c=JSON.parse(store.get(e)),f=0,g={};$.each(c.data,function(b,c){c.tid==a&&(f=b,g=c)}),$.extend(g,b),c.data.splice(f,1,g);var h=weui.loading("保存中...");store.remove(e),store.set(e,JSON.stringify(c)),h.hide(),weui.toast("模板保存成功",500)}else d.fadeIn(200)}),$(".js_dialog").on("click",".weui-dialog__btn_default",function(){$(this).parents(".js_dialog").fadeOut(200)}),$("#form-pro").on("click","#save-for-temp",function(){if(validateTemp("tempName")){$(this).parents(".js_dialog").fadeOut(200);var a={IsDefault:"0",tempTitle:$("input[name='tempName']").val(),Product:$("select[name='Product']").val(),ProductName:$("input[name='ProductName']").val(),Standard:$("input[name='Standard']").val(),ManufacturerName:$("input[name='ManufacturerName']").val(),MedicineName:$("input[name='MedicineName']").val(),BaseName:$("input[name='BaseName']").val(),Ratio:$("input[name='Ratio']").val(),MedicineStandard:$("select[name='MedicineStandard']").val(),StandardStr:store.get("StandardStr")?store.get("StandardStr"):"",Supplier:$("input[name='Supplier']").val(),QualityRequire:$("input[name='QualityRequire']").val(),Addition:$.trim($("textarea[name='Addition']").val()),Address:Cookies.get("location")?Cookies.get("location"):"暂无位置",Time:(new Date).Format("yyyy-MM-dd hh:mm:ss"),tid:(new Date).getTime()},b=store.get(e)?store.get(e):"";if(b&&""!=b){if(JSON.parse(b).data.length>=$tempNum)return weui.alert("创建最多"+$tempNum+"个模板"),!1}var c=weui.loading("保存中...");if(""==b||isEmpty(JSON.parse(b).data)){var d={data:[]};d.data.unshift(a),store.set(e,JSON.stringify(d))}else{var f=JSON.parse(b);f.data.unshift(a),store.remove(e),store.set(e,JSON.stringify(f))}c.hide(),weui.toast("模板保存成功",500)}}),$(window).on("hashchange",function(a){a.preventDefault();var c=/#tempChoose$/,d=/#addPro$/,e=/#itemSearch$/;if(c.test(a.oldURL)&&d.test(a.newURL)){var f=store.get("seatempPro")?store.get("seatempPro"):"";""!=f&&(isEmpty(JSON.parse(f))||($(".getChooseTemp").text(JSON.parse(f).name).data("tid",JSON.parse(f).id).removeClass("c-c7c7c7").addClass("c-3dbaff"),b(JSON.parse(f).id),store.remove("seatempPro")))}else if(e.test(a.oldURL)&&d.test(a.newURL)){var g=store.get("base")?store.get("base"):"";""!=g&&(isEmpty(JSON.parse(g))||(changeSearch(".sText-base",".sVal-base",JSON.parse(g).name),clearSearch(".sVal-base"),store.remove("base")));var h=store.get("manufacturer")?store.get("manufacturer"):"";""!=h&&(isEmpty(JSON.parse(h))||(changeSearch(".sText-manufacturer",".sVal-manufacturer",JSON.parse(h).name),clearSearch(".sVal-manufacturer"),store.remove("manufacturer")));var i=store.get("medicine")?store.get("medicine"):"",j=$("select[name='MedicineStandard']");i&&""!=i&&(isEmpty(JSON.parse(i))||(changeSearch(".sText-medicine",".sVal-medicine",JSON.parse(i).name),store.set("StandardStr",JSON.parse(i).standard),loadMedicineStandard(j,JSON.parse(i).standard),clearSearch(".sVal-medicine"),store.remove("medicine")))}})});